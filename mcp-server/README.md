# Mapannai AI ä¸­é—´å±‚

åŸºäº Ollama å’Œ MCP æœåŠ¡çš„æ™ºèƒ½æ—…æ¸¸è§„åˆ’åŠ©æ‰‹ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¤– **æ™ºèƒ½å¯¹è¯**ï¼šåŸºäº Ollama çš„è‡ªç„¶è¯­è¨€å¤„ç†
- ğŸ—ºï¸ **åœ°å›¾æ“ä½œ**ï¼šåˆ›å»ºã€æŸ¥çœ‹ã€åˆ é™¤æ ‡è®°ç‚¹
- ğŸ” **åœ°ç‚¹æœç´¢**ï¼šæœç´¢é™„è¿‘æ™¯ç‚¹å’Œåœ°ç‚¹
- ğŸ“… **è¡Œç¨‹è§„åˆ’**ï¼šæ™ºèƒ½ç”Ÿæˆæ—…æ¸¸è®¡åˆ’
- ğŸ”§ **å·¥å…·è°ƒç”¨**ï¼šè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾å¹¶è°ƒç”¨ç›¸åº”å·¥å…·
- ğŸŒ **ç½‘é¡µæ§åˆ¶å°**ï¼šç›´è§‚çš„ Web ç•Œé¢

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
nano .env
```

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼
npm run ai:dev

# ç”Ÿäº§æ¨¡å¼
npm run build
npm run ai
```

### 4. è®¿é—®æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:3001

## ç¯å¢ƒå˜é‡

```env
# Ollama é…ç½®
OLLAMA_API_URL=http://192.168.13.3:11434
OLLAMA_MODEL=qwen3:4b

# AI ä¸­é—´å±‚é…ç½®
AI_MIDDLEWARE_PORT=3001

# Mapannai API é…ç½®
MAPANNAI_API_URL=http://localhost:3000
MAPANNAI_API_KEY=your_api_key_here
```

## API æ¥å£

### å¥åº·æ£€æŸ¥
```http
GET /health
```

### AI å¯¹è¯
```http
POST /chat
Content-Type: application/json

{
  "message": "æˆ‘æƒ³åˆ›å»ºä¸€ä¸ªæ ‡è®°ç‚¹",
  "conversation": []
}
```

### è·å–å·¥å…·åˆ—è¡¨
```http
GET /tools
```

### ç›´æ¥è°ƒç”¨å·¥å…·
```http
POST /tools/call
Content-Type: application/json

{
  "toolName": "create_marker",
  "arguments": {
    "coordinates": { "latitude": 39.9042, "longitude": 116.4074 },
    "title": "å¤©å®‰é—¨",
    "iconType": "landmark"
  }
}
```

## æ”¯æŒçš„å·¥å…·

1. **create_marker** - åˆ›å»ºåœ°å›¾æ ‡è®°
2. **create_marker_v2** - é€šè¿‡åœ°ååˆ›å»ºæ ‡è®°ï¼ˆå†…éƒ¨æœç´¢åæ ‡ï¼‰ã€‚ä¸ºæé«˜å‡†ç¡®åº¦ï¼Œè¯·å°½é‡æä¾›æ›´å…·ä½“çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚â€œå‡½é¦†å±±é™„è¿‘ ç‚¸çŒªæ’åº—â€ã€‚
3. **update_marker_content** - æ›´æ–°æ ‡è®°å†…å®¹
4. **create_travel_chain** - åˆ›å»ºæ—…æ¸¸è¡Œç¨‹é“¾
5. **search_places** - æœç´¢åœ°ç‚¹
6. **get_markers** - è·å–æ‰€æœ‰æ ‡è®°
7. **get_marker** - è·å–ç‰¹å®šæ ‡è®°
8. **create_travel_plan** - åˆ›å»ºæ—…æ¸¸è®¡åˆ’ï¼ˆMCP æœåŠ¡å™¨å†…éƒ¨å®ç°ï¼‰

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´æ—…æ¸¸è§„åˆ’
```
### é€šè¿‡åœ°ååˆ›å»ºæ ‡è®°ï¼ˆv2ï¼‰
```http
POST /tools/call
Content-Type: application/json

{
  "toolName": "create_marker_v2",
  "arguments": {
    "name": "å‡½é¦†å±±é™„è¿‘ ç‚¸çŒªæ’åº—",
    "iconType": "food",
    "content": "æ‹›ç‰ŒçŒªæ’ï¼Œå¤œæ™¯è§†é‡å¥½"
  }
}
```
ç”¨æˆ·ï¼šè¯·ä¸ºæˆ‘è§„åˆ’ä¸€ä¸ªäº¬éƒ½ä¸€æ—¥æ¸¸ï¼ŒåŒ…å«ç»å…¸æ™¯ç‚¹ã€ç¾é£Ÿæ¨èå’Œåˆç†çš„æ¸¸è§ˆè·¯çº¿

AIï¼šæˆ‘æ¥ä¸ºæ‚¨è§„åˆ’ä¸€ä¸ªå®Œæ•´çš„äº¬éƒ½ä¸€æ—¥æ¸¸ï¼

## ç¬¬ä¸€æ­¥ï¼šè§„åˆ’æ™¯ç‚¹
è®©æˆ‘å…ˆåˆ†æäº¬éƒ½çš„ç»å…¸æ™¯ç‚¹ï¼Œé€‰æ‹©æœ€é€‚åˆä¸€æ—¥æ¸¸çš„è·¯çº¿...

[AI ä¼šæµå¼åˆ›å»ºæ ‡è®°ç‚¹ï¼Œç”Ÿæˆè¯¦ç»†ä¿¡æ¯ï¼Œåˆ›å»ºè¡Œç¨‹é“¾ç­‰]
```

## æ•…éšœæ’é™¤

### 1. Ollama æœåŠ¡ä¸å¯ç”¨
```bash
# æ£€æŸ¥ Ollama æœåŠ¡çŠ¶æ€
curl http://192.168.13.3:11434/api/tags

# å¯åŠ¨ Ollama æœåŠ¡
ollama serve
```

### 2. æ¨¡å‹æœªå®‰è£…
```bash
# æ‹‰å–æ¨¡å‹
ollama pull qwen3:4b
```

### 3. ç«¯å£å†²çª
```bash
# ä¿®æ”¹ç«¯å£
export AI_MIDDLEWARE_PORT=3002
npm run ai
```

## é¡¹ç›®ç»“æ„

```
mcp-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ ai-middleware.ts    # AI ä¸­é—´å±‚ä¸»æ–‡ä»¶
â”‚   â”œâ”€â”€ index.ts           # MCP æœåŠ¡å™¨
â”‚   â”œâ”€â”€ api-client.ts      # API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ types.ts           # ç±»å‹å®šä¹‰
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html         # ç½‘é¡µæ§åˆ¶å°
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## å¼€å‘è¯´æ˜

### æ·»åŠ æ–°å·¥å…·

1. åœ¨ `ai-middleware.ts` çš„ `callTool` æ–¹æ³•ä¸­æ·»åŠ æ–°å·¥å…·çš„å¤„ç†é€»è¾‘
2. åœ¨ `parseToolCalls` æ–¹æ³•ä¸­æ·»åŠ å·¥å…·è°ƒç”¨æ£€æµ‹è§„åˆ™
3. æ›´æ–° `/tools` ç«¯ç‚¹è¿”å›çš„å·¥å…·åˆ—è¡¨

### è‡ªå®šä¹‰ AI è¡Œä¸º

ä¿®æ”¹ `processMessage` æ–¹æ³•ä¸­çš„ç³»ç»Ÿæç¤ºè¯æ¥æ”¹å˜ AI çš„è¡Œä¸ºæ¨¡å¼ã€‚

## æ³¨æ„äº‹é¡¹

- ç¡®ä¿ Ollama æœåŠ¡æ­£å¸¸è¿è¡Œ
- ç¡®ä¿ Mapannai API æœåŠ¡å¯è®¿é—®
- æ¨¡å‹ `qwen3:4b` éœ€è¦è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æº
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ›´ç¨³å®šçš„æ¨¡å‹